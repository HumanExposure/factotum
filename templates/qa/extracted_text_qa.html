{% extends 'core/base.html' %}
{% load staticfiles %}'

{% load humanize %}
{% if messages %}
    {% for message in messages %}
        <p>{{ message }}</p>
    {% endfor %}
{% endif %}



{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/qa">QA</a></li>
      <li class="breadcrumb-item">
           <a href='{% url "extraction_script_qa" script.id %}'> {{ script }} </a>
    </li>
      <li class="breadcrumb-item active" aria-current="page">{{ doc.title }}</li>
    </ol>
  </nav>

{% if True %} 

  <div class="card">
                    <h3 class="card-header">{{ doc.title }}</h3>
                  
    <div class="card-body">  
        <dl class="row col-sm-12">
            <dt class="col-sm-3">File Name</dt>
            <dd class="col-sm-9">{{ doc.filename }}</dd>
            <dt class="col-sm-3">URL</dt>
            <dd class="col-sm-9">{{ doc.url }}</dd>
            {% if doc.matched %}
            <dt class="col-sm-3">PDF</dt>
                <dd class="col-sm-9">
                    <a href="/media/{{ doc.data_group.dgurl }}/pdf/{{ doc.filename }}"
                        title="Link to {{ doc.filename }}" target="_blank">{{ doc.title }}</a>
                </dd>
            {% endif %}
            <dt class="col-sm-3">Product Category</dt>
            <dd class="col-sm-9">{{ doc.product_category }}</dd>
            <dt class="col-sm-3">Data Group</dt>
            <dd class="col-sm-9">
                <a title="Data Group"
                    href="{% url 'data_group_detail' doc.data_group.id %}"> {{ doc.data_group }}
                </a>
            </dd>

        </dl>
        </div>
</div>
{% endif %}

<div class="row">
    <div class="col">
    <div class="card">
            <h3 class="card-header">Extracted Text</h3>
        <div class="card-body">
        <dl class="row col-sm-12">
                <dt class="col-sm-3">Record Type</dt>
                <dd class="col-sm-9">{{ extracted_text.record_type }}</dd>
                <dt class="col-sm-3">Product Name</dt>
                <dd class="col-sm-9">{{ extracted_text.prod_name }}</dd>
                <dt class="col-sm-3">Document Date</dt>
                <dd class="col-sm-9">{{ extracted_text.doc_date }}</dd>
                <dt class="col-sm-3">QA Checked</dt>
                <dd class="col-sm-9">{{ extracted_text.qa_checked }}</dd>
                <dt class="col-sm-3">QA Status</dt>
                <dd class="col-sm-9">{{ extracted_text.get_qa_status_display }}</dd>
                <dt class="col-sm-3">QA Approval Date</dt>
                <dd class="col-sm-9">{{ extracted_text.qa_approved_date }}</dd>
                <dt class="col-sm-3">QA Approved By</dt>
                <dd class="col-sm-9">{{ extracted_text.qa_approved_by }}</dd>

            </dl>
            {% if notesform.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {% for error in notesform.non_field_errors %}
                {{ error }}
              {% endfor %}
            </div>
            {% endif %}

            <button id="btn-toggle-edit" class="btn btn-secondary" onclick="toggleChemicalEdit()">
                    <span id="btn-toggle-label" class="oi oi-wrench"></span>Edit Extracted Chemicals
            </button>

            <form method="post" >
                            {% csrf_token %}            
                            <div class="row">
                                    <div class="col-10">
                                            {% if error %}
                                            <div class="form-group has-error">
                                                <span class="help-block">{{ error }}</span>
                                            </div>
                                            {% endif %}
                                        {{notesform}}
                                        {{errors}}

                                    </div>
                                </div>
                            {% if extracted_text.qa_checked %}
                            <button type = "submit" id="approve" name="approve" class="btn btn-primary disabled" role="button">Approve</button>
                            {% else %}
                            <button type = "submit" id="approve" name="approve" class="btn btn-primary" role="button">Approve</button>
                            {% endif %}
                            
                            {% if nextid > 0 %}
                                <a class="btn btn-warning" href="{% url "extracted_text_qa" nextid %}" role="button">Skip</a>
                            {% else %}
                                <button type="button" title="All the other documents in this QA group have been approved" class="btn btn-warning" aria-disabled="true" disabled>Skip</button>
                            {% endif %}
                            <a class="btn btn-primary" href="{% url "extraction_script_qa" script.id %}" role="button">Exit</a>
                    


                    <div class="row">
                            <div class="col-sm">

                                {% if extracted_text.qa_checked %}
                                <button type = "submit" id="save_no_approval" name="save_no_approval" class="btn btn-primary disabled" role="button">Save edits</button>
                                {% else %}
                                <button type = "submit" id="save_no_approval"   name="save_no_approval" class="btn btn-primary" role="button">Save edits</button>
                                {% endif %}
                                <button type = "submit" id="test_approval"   name="test_approval" class="btn btn-primary" role="button">Test Approval</button>

                            </div>  
                    </div>

                    <div class="row">
                            {{ chem_formset.management_form }}
                            {% include 'qa/qa_extracted_chemicals.html' with formset=chem_formset %}
                    </div>
                  </form>

            </div>
        </div>
        <p class="card-footer"> {{stats}}</p>
    </div>
    </div>

{% endblock %}
{% block js %}
  <script type="text/javascript">
        window.onload = function() {
        $('.chem-control').prop('disabled', true);
        $('#save_with_approval').addClass('disabled');
        $('#save_no_approval').addClass('disabled');
        $('#btn-approve').removeClass('disabled');
        window.open("/media/{{ doc.data_group.dgurl }}/pdf/{{ doc.filename }}",'pdf',' menubar=0, resizable=0,dependent=0,status=0,width=400,height=7000,left=10,top=10')
        }

        function toggleChemicalEdit() {
            // set the chemical data fields to editable
            // show the notes box
            if ($('#btn-approve').hasClass('disabled'))  {
                // exit edit mode
                $('#save_with_approval').addClass('disabled');
                $('#save_no_approval').addClass('disabled');
                $('#btn-approve').removeClass('disabled');
                $('#btn-toggle-edit').removeClass('btn-warning');
                $('.chem-control').removeClass('unlocked');
                $('.chem-control').prop('disabled', true);
            } else{
                // enter edit mode
                $('#save_with_approval').removeClass('disabled');
                $('#save_no_approval').removeClass('disabled');
                $('#btn-toggle-edit').addClass('btn-warning');
                $('#btn-approve').addClass('disabled');
                $('.chem-control').addClass('unlocked');
                $('.chem-control').prop('disabled', false);

            }
        }
    
  </script>
{% endblock %}
