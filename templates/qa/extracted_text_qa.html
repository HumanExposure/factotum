{% extends 'core/base.html' %}
{% load staticfiles %}'

{% load humanize %}
{% if messages %}
    {% for message in messages %}
        <p>{{ message }}</p>
    {% endfor %}
{% endif %}



{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/qa">QA</a></li>
      <li class="breadcrumb-item">
           <a href='{% url "extraction_script_qa" script.id %}'> {{ script }} </a>
    </li>
      <li class="breadcrumb-item active" aria-current="page">{{ doc.title }}</li>
    </ol>
  </nav>

  <div class="card">
    <h3 class="card-header text-center">DataDocument: {{ doc.title }}</h3>
    <table class="table table-bordered">

      <tr>
        <th>Data Group</th>
        <td>
          <a title="Data Group"
              href="{% url 'data_group_detail' doc.data_group.id %}"> {{ doc.data_group }}
          </a>
        </td>
      </tr>
      <tr>
        <th>Product Category</th>
        <td>
          {{ doc.product_category }}
        </td>
      </tr>
      <tr>
        <th>URL</th>
        <td>
          {{ doc.url }}
        </td>
      </tr>
      {% if doc.matched %}
      <tr>
        <th>PDF</th>
        <td>
          <a href="/media/{{ doc.data_group.dgurl }}/pdf/{{ doc.filename }}"
              title="Link to {{ doc.filename }}" target="_blank">{{ doc.filename }}</a>
          <small><i>click to open PDF in new window</i></small>
        </td>
      </tr>
      {% endif %}
    </table>
</div>

<div class="row">
    <div class="col">
    <div class="card">
      <div class="card-header form-inline">
        <h3 class="text-center col-9">Extracted Text</h3>
      <button type="button" id="btn-toggle-edit" data-toggle="button" class="btn btn-secondary" onclick="toggleChemicalEdit(true)">
              <span id="btn-toggle-label" class="oi oi-wrench"></span>Edit Extracted Chemicals
      </button>
      </div>
    <div class="card-body">
      <!-- {% if notesform.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for error in notesform.non_field_errors %}
          {{ error }}
        {% endfor %}
      </div>
      {% endif %} -->
    <form method="post" >
      {% csrf_token %}
      <div class="row">
        <div class=" col-sm-3 card">
          <div class="card-header">
            <h4>Extracted Text Data</h4>
          </div>
          <div class="card-body">
            {% if error %}
            <div class="form-group has-error">
                <span class="help-block">{{ error }}</span>
            </div>
            {% endif %}
            {% include 'core/bs4_form_dl.html' with form=notesform %}
            {{errors}}
          </div>
        </div>
        {{ chem_formset.management_form }}
        {% for form in chem_formset.forms %}
        <div class="col-sm-3">
            <div class="card" >
                <div class="card-body">

                    {% for hidden_field in form.hidden_fields %}
                    {{ hidden_field }}
                    {% endfor %}

                    {% for field in form.visible_fields %}
                    <div class="form-group">
                        {{ field.label_tag }}<br>
                        {{ field }}
                        {{ field.errors }}
                    </div>
                    {% endfor %}

                </div>
            </div>
        </div>
        {% endfor %}

      </div>

          <button type = "submit" id="save_no_approval" name="save_no_approval" class="btn btn-primary chem-control" role="button">Save edits</button>
        </form>

            </div>
        </div>

    </div>

    </div>
    <div class="row">
      <button type = "submit" id="approve" name="approve" class="btn btn-success" role="button">Approve</button>

      {% if nextid > 0 %}
          <a class="btn btn-warning" href="{% url "extracted_text_qa" nextid %}" role="button">Skip</a>
      {% else %}
          <button type="button" title="All the other documents in this QA group have been approved" class="btn btn-secondary" aria-disabled="true" disabled>Skip</button>
      {% endif %}
      <a class="btn btn-secondary" href="{% url "extraction_script_qa" script.id %}" role="button">Exit</a>
    </div>
    <p class="card-footer"> {{stats}}</p>

{% endblock %}
{% block js %}
  <script type="text/javascript">
        window.onload = function() {
        // window.open("/media/{{ doc.data_group.dgurl }}/pdf/{{ doc.filename }}",'pdf',' menubar=0, resizable=0,dependent=0,status=0,width=400,height=7000,left=10,top=10')
        toggleChemicalEdit(false);
        }

        function toggleChemicalEdit(enable=true) {
            // set the chemical data fields to editable
            // show the notes box
            if (enable)  {
                // enter edit mode
                $('#save_no_approval').removeClass('disabled');
                $('#btn-toggle-edit').addClass('btn-warning');
                $('#btn-toggle-edit').attr("onclick","toggleChemicalEdit(false)");
                $('.chem-control').addClass('unlocked');
                $('.chem-control').prop('disabled', false);
                $('.extext-control').addClass('unlocked');
                $('.extext-control').prop('disabled', false);
            } else{
                // exit edit mode
                $('#btn-toggle-edit').attr("onclick","toggleChemicalEdit(true)");
                $('#save_with_approval').addClass('disabled');
                $('#btn-toggle-edit').removeClass('btn-warning');
                $('.chem-control').removeClass('unlocked');
                $('.chem-control').prop('disabled', true);
                $('.extext-control').removeClass('unlocked');
                $('.extext-control').prop('disabled', true);
            }
        }

  </script>
{% endblock %}
